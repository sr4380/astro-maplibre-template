---
import type { LayerGroup } from "@types";
import fs from "fs";
import yaml from "js-yaml";

// Load and parse the YAML file
const fileContents = fs.readFileSync(
  "src/pages/_scrollytelling_steps.yaml",
  "utf8"
);

interface MapStep {
  title: string;
  description: string;
  center: [number, number];
  zoom: number;
  pitch?: number;
  bearing?: number;
  media?: string;
  position?: "left" | "right" | "centered" | "full";
  layers?: LayerGroup[];
  persist?: boolean;
  mapAnimation?: "flyTo" | "easeTo" | "jumpTo";
  rotateAnimation?: boolean;
  legend?: { color: string; label: string }[];
}

const mapData: MapStep[] = yaml.load(fileContents) as MapStep[];

export interface Props {
  latitude: number;
  longitude: number;
  zoom: number;
  mapstyle: string;
  container: string;
  interactive?: boolean;
  containerstyle?: string;
  pitch?: number;
  bearing?: number;
  layers?: LayerGroup[];
  mapAnimation?: "flyTo" | "easeTo" | "jumpTo";
  rotateAnimation?: boolean;
}

const {
  latitude,
  longitude,
  zoom,
  mapstyle,
  container,
  interactive,
  containerstyle = "height: 61.8vh",
  pitch,
  bearing,
  layers,
  mapAnimation,
  rotateAnimation,
} = Astro.props;

const layersJson = layers ? JSON.stringify(layers) : undefined;
---

<div class="scrollytelling-container" style="position: relative;">

  <!-- Map Container -->
  <div
    id={container}
    class="maplibre-scrollytelling map-container"
    style={{ width: "100vw", height: "100vh", position: "relative" }}
  >
    <maplibre-map
      data-latitude={latitude}
      data-longitude={longitude}
      data-zoom={zoom}
      data-mapstyle={mapstyle}
      data-container={container}
      data-interactive={interactive}
      data-containerstyle={containerstyle}
      data-pitch={pitch}
      data-bearing={bearing}
      data-layers={layersJson}
      data-map-animation={mapAnimation}
      data-map-rotate-animation={rotateAnimation}
    >
      <link
        rel="stylesheet"
        href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css"
      />
      <script is:inline type="module">
        import maplibregl from "maplibre-gl";
        import { loadMapLayers } from "@lib/utils";

        class MapLibreScrollytellingMap extends HTMLElement {
          constructor() {
            super();

            const map = new maplibregl.Map({
              container: this.dataset.container || "maplibre-map",
              interactive: this.dataset.interactive
                ? JSON.parse(this.dataset.interactive)
                : false,
              center: [
                this.dataset.longitude
                  ? parseFloat(this.dataset.longitude)
                  : 0,
                this.dataset.latitude
                  ? parseFloat(this.dataset.latitude)
                  : 0,
              ],
              zoom: this.dataset.zoom
                ? parseFloat(this.dataset.zoom)
                : undefined,
              style: this.dataset.mapstyle,
            });

            // Legend update function
            function updateLegend(
              legendData: { color: string; label: string }[] | undefined
            ) {
              const legend = document.getElementById("legend");
              if (!legend) return;

              if (!legendData || legendData.length === 0) {
                legend.innerHTML = "";
                return;
              }

              legend.innerHTML = `
                <h4>Legend</h4>
                ${legendData
                  .map(
                    (item: { color: string; label: string }) => `
                    <div class="item">
                      <span class="color" style="background:${item.color}"></span>
                      ${item.label}
                    </div>
                  `
                  )
                  .join("")}
              `;
            }

            map.on("load", () => {
              const sections = document.querySelectorAll("section");

              const observer = new IntersectionObserver(
                (entries) => {
                  entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                      entry.target.classList.add("active");

                      const centerAttr = entry.target.getAttribute("data-center");
                      const center = centerAttr ? JSON.parse(centerAttr) : undefined;
                      const zoomAttr = entry.target.getAttribute("data-zoom");
                      const zoom = zoomAttr ? parseFloat(zoomAttr) : undefined;
                      const pitchAttr = entry.target.getAttribute("data-pitch");
                      const pitch = pitchAttr ? parseFloat(pitchAttr) : undefined;
                      const bearingAttr = entry.target.getAttribute("data-bearing");
                      const bearing = bearingAttr ? parseFloat(bearingAttr) : undefined;

                      // Layers
                      const layersAttr = entry.target.getAttribute("data-layers");
                      const layers = layersAttr ? JSON.parse(layersAttr) : undefined;
                      if (layers) {
                        layers.forEach(
                          (layer: any) => {
                            if (map.getLayer(layer.id)) map.removeLayer(layer.id);
                            if (map.getSource(layer.id)) map.removeSource(layer.id);
                          }
                        );
                        loadMapLayers(map, layers, true);
                      }

                      // Legend
                      const legendAttr = entry.target.getAttribute("data-legend");
                      const legendData = legendAttr ? JSON.parse(legendAttr) : undefined;
                      updateLegend(legendData);

                      // Animate map
                      const mapAnimation =
                        (entry.target.getAttribute("data-map-animation") as
                          | "flyTo"
                          | "easeTo"
                          | "jumpTo") ?? "flyTo";

                      map[mapAnimation]({
                        center,
                        zoom,
                        pitch,
                        bearing,
                        essential: true,
                      });

                      const rotateAnimation =
                        entry.target.getAttribute("data-map-rotate-animation") === "true";

                      if (rotateAnimation) {
                        map.once("moveend", () => {
                          map.rotateTo(map.getBearing() + 180, {
                            duration: 30000,
                            easing: (t) => t,
                          });
                        });
                      }
                    } else {
                      if (!entry.target.getAttribute("data-persist")) {
                        entry.target.classList.remove("active");

                        const layersAttr = entry.target.getAttribute("data-layers");
                        const layers = layersAttr ? JSON.parse(layersAttr) : undefined;
                        if (layers) {
                          layers.forEach((layer: any) => {
                            if (map.getLayer(layer.id)) map.removeLayer(layer.id);
                            if (map.getSource(layer.id)) map.removeSource(layer.id);
                          });
                        }
                      }
                    }
                  });
                },
                { threshold: 0.5 }
              );

              sections.forEach((section) => observer.observe(section));
            });
          }
        }

        window.customElements.define("maplibre-map", MapLibreScrollytellingMap);
      </script>
    </maplibre-map>

    <!-- Legend container -->
    <div id="legend"></div>
  </div>

  <!-- Scrolling Content -->
  <main>
    {mapData.map((step, index) => (
      <section
        id={`section-${index}`}
        data-center={JSON.stringify(step.center)}
        data-zoom={step.zoom}
        data-pitch={step.pitch}
        data-bearing={step.bearing}
        data-layers={JSON.stringify(step.layers)}
        data-legend={step.legend ? JSON.stringify(step.legend) : undefined}
        data-map-animation={step.mapAnimation}
        data-map-rotate-animation={step.rotateAnimation === true ? "true" : "false"}
        class:list={[step.position ? step.position : "lefty", "step"]}
      >
        <div class="step-content">
          <h2>{step.title}</h2>
          <p>{step.description}</p>
          {step.media ? <img src={step.media} alt={step.title} /> : null}
        </div>
      </section>
    ))}
  </main>
</div>

<style>
  #legend {
    position: absolute;
    top: 20px;
    left: 20px;
    background: white;
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 14px;
    z-index: 999;
    box-shadow: 0 0 6px rgba(0,0,0,0.15);
  }

  #legend .item {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }

  #legend .color {
    width: 14px;
    height: 14px;
    margin-right: 8px;
    border: 1px solid #333;
    border-radius: 2px;
  }
</style>
